extends layout.pug
block content
  h1
    | JPDEM Sub-Reach Delineations
  h2
    em
      | An Interactive Demonstration
  p
    | JPDEM provides a set of functions that allow you to determine a collection of outlets for sub-delineations of an overall watershed's area.
  p
    | Once identified, the collection of outlets can be specified as the 
    code
      | initialReachOutlets
    |  of a VELMA simulation configuration, for 
    code
      | MULTI_MODE
    |  simulation runs via either JVelma, or VelmaParllelCmdLine.
  p
    | This document demonstrates the JPDEM functions available for interactively determining a collection of outlets.
  h3
    | Generate flow accumulation ("facc") data
  ol
    li
      | In JPDEM, load an already-flat-processed Grid .asc DEM map (or, load an unprocessed DEM, and flat-process it.
      br
      |  Here's our example DEM loaded into JDPEM:
      br
      |  (The default display shows elevation values in red-scale: black cells have the lowest elevation, brightest red cells have the highest.)
      span 
        img(src="image-ws109_dem_in_jpdem.PNG", alt="DEM in JPDEM")
    li
      | Generate flow accumulation data for the DEM. 
      em
        | JPDEM's reach mapping functions assume flow accumulation is available, and will behave abnormally if it is not.
      br
      |  Select the JPDEM 
      code
        | Tools
      |  --> 
      code
        | Determine Flow Data
      |  menu item, and JPDEM will generate flow accumulation data for each cell in the DEM. After generating facc data for our example DEM, JPDEM shifts the display to show facc cell values in grey-scale. Cells with higher flow accumulation values are darker.
      span 
        img(src="image-ws109_facc_menu_item-cropped.PNG", alt="JPDEM Flow Data menu item")
      br
      span 
        img(src="image-ws109_facc_in_jpdem.PNG", alt="Example Flow Data in JPDEM")
    li
      | Show the High-facc Cells To better distinguish cells with higher facc values, toggle the 
      code
        | Facc Threshold
      |  checkbox and (for our example DEM) set the type, value pair to 
      code
        | Linear
      |  and "50".
      br
      |  All cells in the DEM that have facc values equal or greater than the specified threshold will be colored red.
      span 
        img(src="image-ws109_facc_threshold_cropped.PNG", alt="Facc Threshold Controls")
  h3
    | Set the Primary Outlet
  p
    | The Primary Outlet designates the outlet for the entire watershed. All (sub-)outlets specified via JPDEM's reach mapping functions are assumed to be relative to the Primary Outlet's cell location.
  p
    | There two ways to set the primary outlet:
  ul
    li
      | Directly enter the x and y (column and row) coordinates into the 
      code
        | Outlet
      |  fields on the main display.
    li
      | Mouse-click the cell location within the display, hold the mouse button down and drag the cursor to highlight the 
      code
        | Set As Primary Outlet
      |  item, and finally, release the mouse button.
  p
    | In the mouse-click example screen-captured below, note that the cell we're selecting (circled in black) has a flow-accumulation ("facc") value of 1778. This means that the full watershed delineated from this primary outlet contains 1778 cells.
  img(src="image-ws109_cell_popup_set_primary_edited.PNG")
  h3
    | Add Sub-Outlets to JPDEM's Outlets Set
  p
    | JPDEM maintains a set of cell locations call the 'Outlets Set'. The Outlets Set is a proper set: no cell location can appear in it more than once.
  p
    | There are three ways to add cell locations to the Outlets Set.
  ul
    li
      | Mouse-click the cell location, hold and drag the cursor to highlight the 
      code
        | Add to Reach Map Outlets Set
      |  item.
    li
      | Directly enter one or more cell locations via the 
      code
        | Tools
      |  --> 
      code
        | Add Multiple Outlets to Outlets Set
      |  menu item.
    li
      | Automatically identify and add outlets via the 
      code
        | Tools
      |  --> 
      code
        | Auto-Add Multiple Outlets to Outlets Set
      |  menu item.
  p
    | We'll start by adding some outlets using the mouse. Because we set the facc threshold to 50, we can easily identify cells with facc values of 50 or more. From setting the primary outlet via the mouse, we also know that the primary outlet has a fac value of 1778. Our basic strategy is to mouse-click on darker cells adjacent to facc-threshold cells and find values close to 50. We'll also consider facc-threshold cells themselves, if they're sufficiently far from the primary outlet. Here's a screen-capture showing the first cell we add to the Outlets Set:
  img(src="image-ws109_cell_popup_add_outlet_edited.PNG", alt="Adding a cell to Outlets Set with the mouse")
  p
    | We continue on this for more cells, trying to select locations that are close to 50 or look like forks in the facc-threshold "channels". As we add cells to the Outlets Set, JPDEM colors them green (a slightly lighter shade of green than the primary outlet).
  img(src="image-ws109_multiple_outlets_displayed.PNG", alt="Multiple outlet cells in JPDEM")
  h3
    | Create a Reach Map
  p
    | Once we think we have enough sub-outlets added to the Outlets Set, we can create a Reach Map. Creating a reach map is the way JPDEM figures out which cells in the full watershed belong to each of the sub-outlets in the Outlet Set. Clicking the 
    code
      | Tools
    |  --> 
    code
      | Create Create Reach Map Data from Outlets Set
    |  menu item generates reach map data using the current Outlet Set.
  img(src="image-ws109_createReachMap_menu_item_cropped.PNG", alt="Create Reach Map menu item")
  p
    | However, when we click 
    code
      | Create Create Reach Map Data from Outlets Set
    |  we get the following options dialog:
  img(src="image-ws109_createReachMap_addPrimary_optionDialog.PNG", alt="Create Reach Map add Primary Outlet Option Dialog")
  p
    | Although we've set the primary outlet at the correct location for our overall watershed, we haven't explicitly added it to the Outlets Set. JPDEM is offering to add it for us, let us proceed without it, or stop creating a Reach Map. For, now let's click "No", and let the process move forward without including the primary outlet.
  p
    | JPDEM generates the Reach Map data, and displays a report of the results in a pop-up dialog window.
  img(src="image-ws109_createReachMap_Results1_edited.PNG", alt="Create Reach Map Report v1")
  p
    | In the reach map result screen-captured above, note the red-underlined sub-reach at iOutlet=3387, with only 9 cells. We decide that a 9-cell sub-reach isn't worth keeping, and that we don't need this outlet in the Outlet Set. Fortunately, we can remove it using the mouse-click menu. When you mouse-click a cell that is a member of the Outlets Set, the mouse-click menu contains a 
    code
      | Remove Frome Reach Map Outlets Set
    |  item:
  img(src="image-ws109_cell_popup_remove_outlet.PNG", alt="Remove an outlet cell mouse menu item")
  p
    | After removing the under-cell'ed outlet from the Outlets Set, we click 
    code
      | Tools
    |  --> 
    code
      | Create Create Reach Map Data from Outlets Set
    |  again. This time we get a warning that we will lose our previous reach map results (but 
    em
      | not
    |  our Outlets Set).
  img(src="image-ws109_reachMap_overwrite_ok_dialog.PNG", alt="Reach Map replacement warning dialog")
  p
    | Since we 
    em
      | do
    |  want a new reach map, we lick 
    code
      | OK
    |  and continue, again clicking "No" for the "Add Primary Outlet" option. The new report shows that the remaining sub-outlets all have a "enough" cells for our purposes, so we move on to see what the Reach Map looks like.
  h3
    | View the Reach Map
  p
    | When Reach Map data is available, JPDEM has a (limited) way of displaying the sub-reaches spatially. Continuing on with the Outlets Set and Reach Map we created above, we click the 
    code
      | Tools
    |  --> 
    code
      | View Outlets, Reach State
    |  --> 
    code
      | View Reach Map
    |  menu item:
  img(src="image-ws109_viewReachMap_reachMap-menu_item_edited.PNG", alt="View Reach Map menu item")
  img(src="image-ws109_viewReachMap_Display1.PNG", alt="Reach Map Display v1")
  p
    | The reach map is displayed at the same scale that JPDEM is set to when the 
    code
      | View Reach Map
    |  item is clicked. Cells outside of the the watershed are colored black -- and, hang on, the above map doesn't look quite right, does it?
    br
    |  In fact, it 
    em
      | isn't
    |  right -- but it 
    em
      | is
    |  accurate.
    br
    |  What's 
    em
      | wrong
    |  is that we neglected to include the primary outlet in our Outlet Set. We can verify this is the case by mouse-clicking on the outlet cell: the mouse-click menu does not include the 
    code
      | Remove Frome Reach Map Outlets Set
    |  item. This means that the cell is not a member of the Outlets Set. We can add it by clicking the 
    code
      | Add to Reach Map Outlets Set
    |  mouse-click menu item, or we can use the 
    code
      | Tools
    |  --> 
    code
      | Add Multiple Outlets to Outlets Set
    | , or we can simply run the 
    code
      | Create Create Reach Map Data from Outlets Set
    |  item once again, and this time, click "Yes" for the "Add Primary Outlet" option. After doing so, the resulting report confirms that the primary outlet is now part of the Outlets Set, and the Reach Map viewer no longer looks "wrong":
  img(src="image-ws109_createReachMap_Results3_edited.PNG", alt="Create Reach Map Report v3")
  img(src="image-ws109_viewReachMap_Display2.PNG", alt="Reach Map Display v2")
  h3
    | Use the Outlets Set in a VELMA Simulation Configuration
  p
    | Once we're satisfied that the outlets in the Outlets Set form a satisfactory collection of watershed sub-reaches, we'd like to use that set of outlets in an appropriate VELMA simulation configuration.
  p
    | By "appropriate", we mean that the VELMA simulation configuration should already be configured to use the same primary outlet location that we've been using in JPDEM.
    br
    |  
    em
      | Neither JPDEM nor VELMA provides any automatic way to enforce this requirement
    | .
  p
    | Assuming we have an appropriate VELMA simulation configuration .xml file available, JDPEM's 
    code
      | File
    |  --> 
    code
      | Save Outlets Set As
    |  --> 
    code
      | Modified VELMA XML
    |  menu item provides a way to transfer JPDEM's current Outlets Set to that .xml file.
  img(src="image-ws109_save-to-velma_menu_item_cropped_edited.PNG", alt="Save Outlets Set menu item")
  p
    | The 
    code
      | Modified VELMA XML
    |  item first asks for a VELMA .xml file to use as an initial source configuration:
  img(src="image-ws109_save-to-velma_openSource_dialog_edited.PNG", alt="Open VELMA source file dialog")
  p
    | Use the "Look In:" drop-down control and the associated navigation buttons to locate the directory of the appropriate VELMA .xml file.
    br
    |  Click-select the VELMA .xml file itself in the files menu, and verify it in the "File Name:" text box.
    br
    |  Finally, click the "Load File" button to confirm this is the file to use.
  p
    | Once we've specified the appropriate VELMA .xml file, JPDEM performs the following actions:
  ol
    li
      | Opens the .xml file and reads the contents.
    li
      | Finds the 
      code
        | enableReachMapping
      |  parameter and sets its value to 
      code
        | MULTI_MODE
    li
      | Finds the 
      code
        | initialReachOutlets
      |  parameter and sets its value to the current Outlets Set.
    li
      | Opens a 
      code
        | Save Modified ...
      |  dialog box to enable saving the changes just made.
  p
    | The 
    code
      | Save Modified ...
    |  dialog box looks like this:
  img(src="image-ws109_save-to-velma_saveTarget_dialog_edit.PNG", alt="Save VELMA target file dialog")
  p
    | Use the "Save In:" drop-down control and the associated navigation buttons to locate the directory to save the modified (or new) VELMA .xml file. The "File Name:" text box is initially set to the name of the VELMA source .xml file, if we want to overwrite that file's contents with our modified contents, then we can click the 
    code
      | Save File
    |  button and be done.
    br
    |  However, we can also change the 
    code
      | File Name:
    | , to either overrite a different existing file 
    em
      | (not recommended)
    |  or create a new file.
  p
    | Assuming we opt to create a new file, we can compare the original source file's 
    code
      | enableReachMapping
    |  and 
    code
      | initialReachOutlets
    |  parameters with the modified file's and confirm that JPDEM modified their values:
    br
    |  VELMA original .xml:
  pre
    code
      | /calibration/VelmaInputs.properties/enableReachMapping, SOLO_MODE  
      | /calibration/VelmaInputs.properties/initialReachOutlets,

  p
    | VELMA modified .xml:
  pre
    code
      | /calibration/VelmaInputs.properties/enableReachMapping, MULTI_MODE  
      | /calibration/VelmaInputs.properties/initialReachOutlets, 2433 3236 2181 3590 1735 4171 4172 1997 2094 2256 3408 2865 3505 2706 2866 3059 2260 3060 2620

  p
    | There is an alternate to transfer an Outlets Set from JPDEM to an appropriate VELMA .xml file.
    br
    |  It is arguably more straightforward, but it also involves more more steps.
  p
    | Open the JPDEM 
    code
      | Tools
    |  --> 
    code
      | View Outlets Report
    |  and highlight-copy the "simple list" of outlets at the bottom of the report to the system clipboard by using pressing the 
    code
      | Ctrl
    | +
    code
      | v
    |  key combination.
  img(src="image-ws109_viewReachMap_outlets-menu_item_edited.PNG", alt="View Outlets Report menu item")
  img(src="image-ws109_outlets_report.PNG", alt="View Outlets Report window")
  p
    | Open JVelma, and load the appropriate simulation configuration .xml file, and edit the "Sub-Reach Mapping Controls" in the 
    code
      | Run Parameters
    |  tab:
  img(src="image-ws109_velma_run_parameters_cropped_edited.PNG", alt="VELMA Sub-Reach Mapping Controls")
  p
    | Use the drop-down selector to set the configuration to 
    code
      | MULTI_MODE
    |  and paste the list of outlets copied from the JDPEM outlets report dialog into the adjacent text box by clicking on the text box and pressing the 
    code
      | Ctrl
    | +
    code
      | p
    |  key combination.
  p
    | If we plan to create a new simulation cofiguration .xml file from this modified original, we should also change the 
    code
      | Simulation Run Name
    |  parameter (see the red question mark in the above image).
  p
    | Finally, use JVelma's 
    code
      | File
    |  --> 
    code
      | Save Configuration to VELMA XML File
    |  menu item to save the MULTI_MODE, outlets-specified configuration.